<?xml version="1.0" encoding="utf-8"?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:render="component.Render.*"
	xmlns:Render="component.SurveyUI.Render.*"
	layout="absolute" width="600" height="800"
	 >
	<mx:Script>
		<![CDATA[
		import mx.events.ValidationResultEvent;
		import mx.events.IndexChangedEvent;
		import mx.containers.Canvas;
		import component.SurveyUI.Render.*;
		import net.isurvey.event.*;
		import net.isurvey.model.*;
		import com.adobe.cairngorm.control.CairngormEventDispatcher;
		import com.adobe.cairngorm.control.CairngormEvent;
		
		private var surveydata:SurveyData = new SurveyData();
		private var md:SurveyModelLocator = SurveyModelLocator.getInstance();
		
			
		
		public function init():void{
			acQuestionList.removeAllChildren();
		}
		
		public function validate( event:Event ):void{
			var snvr:ValidationResultEvent = vdSurveyName.validate();
			var sdvr:ValidationResultEvent = vdSurveyDescription.validate();
			if ( snvr.type == ValidationResultEvent.VALID &&
				 sdvr.type == ValidationResultEvent.VALID &&
				 dtCreateDate.selectedDate < dtEndDate.selectedDate
				 ) btnAddQuestion.enabled = true;
			else btnAddQuestion.enabled = false;
		}
		
		/*
		 * TODO:
		 * 允许用户在编辑各个问题的时候自由的切换，但是如果当前编辑的问题没有完成或者有校验错误的时候
		 × 不允许用户继续添加新的问题
		 */
		public function onAddQuestion( event:Event ) :void{
			var cq:CreateQuestion = new CreateQuestion();
			cq.percentWidth = 100;
			acQuestionList.addChild( cq );
		}
		
		private function setCurrentSurvey():void{
			surveydata.description = txtSurveyDescription.text;
			surveydata.createdate = dtCreateDate.selectedDate;
			surveydata.expiredate = dtEndDate.selectedDate;
			surveydata.questionlist.removeAll();
			
			for each ( var item:CreateQuestion in acQuestionList.getChildren() ){
				surveydata.questionlist.addItem( item.getQuestionData() );
			}
			surveydata.questioncount = surveydata.questionlist.length;
			surveydata.pollcount = 0;
			surveydata.username = "wang";//TODO:ADD HERE TO GET 
		}
		
		public function onSubmitSurvey( event:Event ) :void{
			this.setCurrentSurvey();
			var evt:ManageSurveyEvent = new ManageSurveyEvent( ManageSurveyEvent.ADD_SURVEY );
			evt.surveydata = surveydata;	 			
			CairngormEventDispatcher.getInstance().dispatchEvent( evt );
		}
		
			
		]]>
	</mx:Script>
	
	<mx:StringValidator id="vdSurveyName" source="{txtSurveyName}" property="text"
		 maxLength="20" minLength="5"/>
	<mx:StringValidator id="vdSurveyDescription" source="{txtSurveyDescription}" property="text"
		 maxLength="60" minLength="4"/>
	
<mx:Canvas  width="100%" height="100%" 
	xmlns:Survey="component.SurveyUI.*"
	creationComplete="init()">
	<mx:VBox width="100%" height="100%">
	<mx:ApplicationControlBar top="0" width="100%" horizontalCenter="0" height="50">
		<mx:Spacer width="10"/>
		<mx:Image source="@Embed(source='images/1.gif')" />
		<mx:Spacer width="120"/>
		<mx:Label text="调查" fontSize="20" fontWeight="bold" textAlign="center" width="100" color="#FFFFFF"/>
	</mx:ApplicationControlBar>
	
		<mx:Form width="100%" left="3" top="3">
		<mx:FormItem label="主题名" width="100%" fontSize="14" required="true">
			<mx:TextInput id="txtSurveyName" 
				 change="validate(event)"
				width="100%" height="100%" textAlign="right"/>
		</mx:FormItem>
		<mx:FormItem label="主题背景描述" width="100%" fontSize="14" required="true">
			<mx:TextArea id="txtSurveyDescription" 
				 change="validate(event)"
				width="100%" height="100%"/>
		</mx:FormItem>
		<mx:FormItem label="主题发布时间" width="100%" fontSize="14" required="true">
			<mx:DateField id="dtCreateDate" width="100%" height="100%"
				 change="validate(event)"/>
		</mx:FormItem>
		<mx:FormItem label="主题截止时间" fontSize="14" width="100%" required="true">
			<mx:DateField id="dtEndDate" width="100%" height="100%"
				change="validate(event)"/>
		</mx:FormItem>
		<mx:FormItem label="是否默认主题" width="100%" fontSize="14" required="true">
			<mx:HBox width="100%" height="100%">
				<mx:Spacer width="20%"/>
				<mx:RadioButton x="0" y="-2" label="是" selected="true" enabled="false"/>
				<mx:RadioButton x="70" y="-2" label="否" selected="true" enabled="false"/>
			</mx:HBox>
		</mx:FormItem>
	</mx:Form>
	<mx:ApplicationControlBar width="100%" dock="true">
		<mx:Button id="btnAddQuestion" 
			 click="onAddQuestion(event)"
			label="添加问题" enabled="false"/>
	</mx:ApplicationControlBar>
	<mx:Accordion id = "acQuestionList"		 
		width="100%" horizontalCenter="0" top="70">
		<Render:CreateQuestion label="Theme1" width="100%"/>
		<Render:CreateQuestion label="Theme1" width="100%"/>

	</mx:Accordion>
	
	<mx:ApplicationControlBar width="100%">
		<mx:Button id="btnSubmitSurvey" 
			 click="onSubmitSurvey(event)"
			label="提交问卷"/>
	</mx:ApplicationControlBar>
</mx:VBox>
	

</mx:Canvas>
</mx:Module>

